name: Daily Weather Data Update

# Workflow triggers
on:
  # Run automatically every day at 6:00 AM UTC (1:00 AM EST)
  schedule:
    - cron: '0 6 * * *'

  # Allow manual triggering from the GitHub Actions tab
  workflow_dispatch:

# Grant permissions to push changes back to the repository
permissions:
  contents: write

jobs:
  update-weather-data:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper git operations
          fetch-depth: 0

      # Step 2: Set up Python environment
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # Cache pip packages for faster workflow runs
          cache: 'pip'

      # Step 3: Install required Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Run the weather forecast script to fetch fresh data
      - name: Fetch and generate weather data
        id: fetch_weather
        run: |
          echo "Running weather forecast script..."
          python weather_forecast.py
          echo "Weather data updated successfully"
          # Capture the current timestamp for the DATA_INFO.md update
          echo "timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        continue-on-error: false

      # Step 5: Update DATA_INFO.md with the latest timestamp
      - name: Update DATA_INFO.md timestamp
        run: |
          if [ -f DATA_INFO.md ]; then
            sed -i "s/Last Updated: .*/Last Updated: ${{ steps.fetch_weather.outputs.timestamp }}/" DATA_INFO.md
          fi

      # Step 6: Check if there are any changes to commit
      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet weather_historical_forecast.csv temperature_historical_forecast.png temperature_historical_forecast.html docs/ DATA_INFO.md || echo "changes=true" >> $GITHUB_OUTPUT

      # Step 7: Configure Git with bot credentials
      - name: Configure Git
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # Step 8: Commit the updated files
      - name: Commit updated weather data
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git add weather_historical_forecast.csv temperature_historical_forecast.png temperature_historical_forecast.html docs/ DATA_INFO.md
          git commit -m "ü§ñ Auto-update weather data - $(date -u '+%Y-%m-%d %H:%M UTC')" \
                     -m "Automated daily weather data refresh" \
                     -m "Data fetched from Open-Meteo API" \
                     -m "" \
                     -m "Updated files:" \
                     -m "- weather_historical_forecast.csv" \
                     -m "- temperature_historical_forecast.png" \
                     -m "- temperature_historical_forecast.html" \
                     -m "- docs/ (GitHub Pages)" \
                     -m "- DATA_INFO.md (timestamp)"

      # Step 9: Push changes back to the main branch
      - name: Push changes
        if: steps.check_changes.outputs.changes == 'true'
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      # Step 10: Report success
      - name: Report success
        if: success()
        run: |
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "‚úÖ Weather data updated and pushed successfully!"
          else
            echo "‚ÑπÔ∏è No changes detected - data is already up to date"
          fi

      # Step 11: Handle errors and send notifications
      - name: Handle failure
        if: failure()
        run: |
          echo "‚ùå Weather data update failed!"
          echo "Please check the workflow logs for details."
          echo "Possible issues:"
          echo "  - API connection problems"
          echo "  - Python script errors"
          echo "  - Git push conflicts"
          exit 1
